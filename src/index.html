<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <meta name="description" content="Helper tool for 'ember' driver of Zigbee2MQTT.">
    <title>Zigbee2MQTT Ember Helper</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
    <link rel="stylesheet" href="index.css" />
</head>

<body>
    <section class="hero is-primary">
        <!-- Hero head: will stick at the top -->
        <div class="hero-head">
            <header class="navbar">
                <div class="container">
                    <div class="navbar-brand">
                        <span class="navbar-item">
                          <img src="https://www.zigbee2mqtt.io/logo.png" alt="Logo" />
                          <span class="pl-2">Zigbee2MQTT Ember Helper</span>
                        </span>
                    </div>
                    <div class="navbar-menu">
                        <div class="navbar-start">
                            <span class="navbar-item">
                                <button onClick="window.location.reload();" class="button is-primary">
                                    <span class="icon">&circlearrowright;</span>
                                    <span>Reload</span>
                                </button>
                            </span>
                        </div>
                    </div>
                    <div class="navbar-menu">
                        <div class="navbar-end">
                            <span class="navbar-item">
                                <a href="https://www.buymeacoffee.com/Nerivec" target="_blank" class="button is-ghost">
                                    <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" class="image">
                                </a>
                            </span>
                        </div>
                    </div>
                </div>
            </header>
        </div>

        <!-- Hero content: will be in the middle -->
        <div id="hero-body" class="hero-body">
            <form id="log-file-form" class="is-flex is-flex-direction-column is-justify-content-center is-align-items-center">
                <div class="field has-addons" title="Log File Timestamp Format (same as configured in Zigbee2MQTT)">
                    <p class="control">
                        <a class="button is-static">&#x1F4C5; Log File Timestamp Format</a>
                    </p>
                    <p class="control">
                        <input class="input" type="text" name="timestamp-format" value="YYYY-MM-DD HH:mm:ss" required="" />
                    </p>
                </div>
                <div class="field has-addons" title="Number of actual routers on the network at the time of the log">
                    <p class="control">
                        <a class="button is-static">&#x1F50C; Routers</a>
                    </p>
                    <p class="control">
                        <input class="input" type="number" name="number-routers" placeholder="Routers" min="0" value="0" required="" />
                    </p>
                </div>
                <div class="field has-addons" title="Number of actual end devices on the network at the time of the log">
                    <p class="control">
                        <a class="button is-static">&#x1F50B; End devices</a>
                    </p>
                    <p class="control">
                        <input class="input" type="number" name="number-devices" placeholder="End Device" min="0" value="0" required="" />
                    </p>
                </div>
                <div class="field has-addons">
                    <p class="control">
                        <a class="button is-static">&#x1F50C; Log File</a>
                    </p>
                    <p class="control">
                        <input class="input" type="file" name="log-file" accept=".txt, .log" required="" title="Select Log File" />
                    </p>
                </div>
                <div class="control">
                    <button type="submit" class="button is-link">Submit</button>
                </div>
            </form>
        </div>

        <!-- Hero footer: will stick at the bottom -->
        <div class="hero-foot">
            <nav class="tabs is-boxed is-fullwidth">
                <div class="container">
                    <ul>
                        <li class="is-active"><a id="menu-home" href="#home">Home</a></li>
                        <li><a id="menu-stats" href="#stats">Stats</a></li>
                        <li><a id="menu-ncp-counters" href="#ncp-counters">NCP Counters</a></li>
                        <li><a id="menu-ash-counters" href="#ash-counters">ASH Counters</a></li>
                        <li><a id="menu-routing" href="#routing">Routing</a></li>
                        <li><a id="menu-tools" href="#tools">Tools</a></li>
                        <li><a id="menu-help" href="#help">Help</a></li>
                    </ul>
                </div>
            </nav>
        </div>
    </section>
    <section id="section-home" class="section">
        <article class="message">
            <div class="message-header">
                <p>Zigbee2MQTT Ember Helper</p>
                <a href="https://github.com/Nerivec/z2m-ember-helper/" target="_blank">Version: 1.0.0 [WIP]</button>
            </div>
            <div class="message-body">
                <p>Get a better understanding of your Zigbee network using Zigbee2MQTT with Ember driver (for EmberZNet-based adapter).</p>
                <p>Enter your network details and provide the log file in the form above.</p>
                <p>&nbsp;</p>
                <p><em>Compatible with Zigbee2MQTT version 1.37.0 or later.</em></p>
            </div>
        </article>
        <article class="message is-warning">
            <div class="message-header">
                <p>Warning</p>
            </div>
            <div class="message-body">
                <p>The information given and derived from this tool comes from a rather small set of data at the moment.</p>
                <p>It is only meant to be indicative and may not be entirely relevant depending on your specific network/environment.</p>
                <p>Values for identifying potential issues remain arbitrary until improved with more feedback.</p>
                <p><em>Processing is done locally in your browser. Your log file doesn't leave your computer.</em></p>
            </div>
          </article>
    </section>
    <section id="section-stats" class="section is-hidden"></section>
    <section id="section-ncp-counters" class="section is-hidden"></section>
    <section id="section-ash-counters" class="section is-hidden"></section>
    <section id="section-routing" class="section is-hidden"></section>
    <section id="section-tools" class="section is-hidden">
        <div class="grid">
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">Multi-devices Flasher</p>
                </header>
                <div class="card-content">
                    Web-based Firmware Flashing by <a href="https://github.com/darkxst" target="_blank">darkxst</a>
                </div>
                <footer class="card-footer">
                    <a href="https://darkxst.github.io/silabs-firmware-builder/" target="_blank" class="card-footer-item">Silabs Firmware Flasher</a>
                </footer>
            </div>
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">Nabu Casa Home Assistant</p>
                </header>
                <div class="card-content">
                    Web-based Firmware Flashing
                </div>
                <footer class="card-footer">
                    <a href="https://skyconnect.home-assistant.io/firmware-update/" target="_blank" class="card-footer-item">SkyConnect Flasher</a>
                </footer>
            </div>
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">SMLight</p>
                </header>
                <div class="card-content">
                    Web-based Firmware Flashing
                </div>
                <footer class="card-footer">
                    <a href="https://smlight.tech/flasher/" target="_blank" class="card-footer-item">SMLight Firmware Updater</a>
                </footer>
            </div>
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">Nabu Casa</p>
                </header>
                <div class="card-content">
                    Command-line tool (also available via <a href="https://github.com/home-assistant/addons/tree/master/silabs_flasher" target="_blank">Home Assistant add-on</a>)
                </div>
                <footer class="card-footer">
                    <a href="https://github.com/NabuCasa/universal-silabs-flasher" target="_blank" class="card-footer-item">Universal Silabs Flasher</a>
                </footer>
            </div>
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">Silicon Labs</p>
                </header>
                <div class="card-content">
                    Flash Programmer included (<a href="https://docs.silabs.com/simplicity-studio-5-users-guide/latest/" target="_blank">instructions</a>)
                </div>
                <footer class="card-footer">
                    <a href="https://www.silabs.com/developers/simplicity-studio" target="_blank" class="card-footer-item">Simplicity Studio</a>
                </footer>
            </div>
        </div>
        <article class="message">
            <div class="message-header">
                <p>Note</p>
            </div>
            <div class="message-body">
                Some Ethernet adapters support flashing Zigbee firmware over their own web-interface. In this case you do not need any external software and hardware. Just go to the webinterface and press "Update Zigbee firmware". Please refer to the manual of your particular Zigbee adapter for this functionality.
            </div>
        </article>
        <article class="panel is-success">
            <p class="panel-heading">Current Recommended Firmware</p>
            <div class="panel-block">
              <p class="control has-icons-left">
                Built by <a href="https://github.com/darkxst" target="_blank">darkxst</a>. See <a href="https://github.com/darkxst/silabs-firmware-builder/" target="_blank">Github README</a> for more details.
              </p>
            </div>
            <a class="panel-block" href="https://github.com/darkxst/silabs-firmware-builder/raw/main/firmware_builds/zbdonglee/ncp-uart-hw-v7.4.1.0-zbdonglee-115200.gbl" target="_blank">
                <span class="panel-icon">&#128190;</span>
                Sonoff ZBDongle-E
            </a>
            <a class="panel-block" href="https://github.com/darkxst/silabs-firmware-builder/raw/ember-nohw/firmware_builds/skyconnect/ncp-uart-hw-v7.4.1.0-skyconnect-115200.gbl" target="_blank">
                <span class="panel-icon">&#128190;</span>
                Home Assistant SkyConnect
            </a>
            <a class="panel-block" href="https://github.com/darkxst/silabs-firmware-builder/raw/ember-nohw/firmware_builds/yellow/ncp-uart-hw-v7.4.1.0-yellow-115200.gbl" target="_blank">
                <span class="panel-icon">&#128190;</span>
                Home Assistant Yellow
            </a>
            <a class="panel-block" href="https://github.com/darkxst/silabs-firmware-builder/raw/ember-nohw/firmware_builds/slzb-07/ncp-uart-hw-v7.4.1.0-slzb-07-115200.gbl" target="_blank">
                <span class="panel-icon">&#128190;</span>
                SMLight SLZB07
            </a>
            <a class="panel-block" href="https://github.com/darkxst/silabs-firmware-builder/raw/main/firmware_builds/slzb-06m/ncp-uart-hw-v7.4.1.0-slzb-06m-115200.gbl" target="_blank">
                <span class="panel-icon">&#128190;</span>
                SMLight SLZB06-M
            </a>
            <a class="panel-block" href="https://github.com/darkxst/silabs-firmware-builder/raw/ember-nohw/firmware_builds/zb-gw04-1v2/ncp-uart-hw-v7.4.1.0-zb-gw04-1v2-115200.gbl" target="_blank">
                <span class="panel-icon">&#128190;</span>
                EasyIot ZB-GW04 v1.2
            </a>
            <a class="panel-block" href="https://github.com/darkxst/silabs-firmware-builder/raw/main/firmware_builds/zb-gw04-1v1/ncp-uart-hw-v7.4.1.0-zb-gw04-1v1-115200.gbl" target="_blank">
                <span class="panel-icon">&#128190;</span>
                EasyIot ZB-GW04 v1.1
            </a>
            <a class="panel-block" href="https://github.com/tube0013/tube_gateways/blob/main/models/current/tubeszb-efr32-MGM24/firmware/mgm24/ncp/4.4.1/tubesZB-EFR32-MGM24_NCP_7.4.1.gbl" target="_blank">
                <span class="panel-icon">&#128190;</span>
                TubeZB MGM24 (by @tube0013)
            </a>
        </article>
    </section>
    <section id="section-help" class="section is-hidden">
        <div class="content">
            <h3>Logging specific to `ember`</h3>
            <article class="message is-info">
                <div class="message-header">Info level</div>
                <div class="message-body">
                    <p>The start and stop sequences describe the steps taken to get Zigbee2MQTT running with `ember` in more details. This should help to locate potential start and stop problems.</p>
                    <p>Stack/Network status changes (up/down, channel change, open/close from Permit Join, etc).</p>
                </div>
            </article>
            <article class="message is-warning">
                <div class="message-header">Warning level</div>
                <div class="message-body">
                    <p><em>Node descriptor reports device is only compliant to revision</em>: Device identified as having an older Zigbee revision. These can be the source of problems, especially if `pre-21`.</p>
                    <p><em>[EzspConfigId] Failed to SET</em>: Usually when the coordinator has lower memory than others. In-firmware value will be used instead.</p>
                    <p><em>An ID conflict was detected</em>: Two devices cannot have the same ID on the same network. The involved devices are kicked off the network then should rejoin (may need to re-pair them if not).</p>
                    <p><em>Network/Route error</em>: The error indicates that there was a problem sending/receiving messages from the target node (see below for more details). A few of these over time is expected (or on Zigbee2MQTT start), too many, too often, is indicative of a problem in your network.</p>
                    <p><em>NOT READY - Signaling NCP</em>: `ember` driver is temporarily overloaded. The coordinator is made aware and processing is deferred for a short period.</p>
                </div>
            </article>
            <article class="message is-danger">
                <div class="message-header">Error level</div>
                <div class="message-body">
                    <p><em>NCP EZSP protocol version of XX does not match Host version 13</em>: `ember` currently requires a firmware with EZSP v13 (EmberZNet firmware 7.4.x). You will need to upgrade your adapter's firmware. <a href="https://github.com/Koenkk/zigbee2mqtt/discussions/21462" target="_blank">Check the first two posts here</a>.</p>
                    <p><em>[BACKUP] Current backup file is from an unsupported EZSP version</em>: `ember` currently only supports EZSP v12 and above backups (can be identified by opening the `coordinator_backup.json` file). You will need to rename/move/delete the backup file. <em>An alternative is to upgrade your firmware to 7.3.1 and start `ezsp` once (which will create a more recent backup), then upgrade to 7.4.1 and switch to `ember`.</em></p>
                    <p>Failed delivery of a message. The target device could not be reached. There can be several causes for this, the rest of the logs should help identify which.</p>
                    <p>Failed request. Message should be self-explanatory, and give a `status` indicating the reason of the failure.</p>
                    <p>NCP Fatal Error. The coordinator failed (the reason should be given in the message). Zigbee2MQTT will attempt to reset it and resume communication. If unsuccessful, Zigbee2MQTT will be stopped completely and the system's watchdog (if any) will attempt to restart it.</p>
                </div>
            </article>
            <article class="message">
                <div class="message-header">
                    <p>Details on Network/Route errors</p>
                </div>
                <div class="message-body">
                    <p>A status of SOURCE_ROUTE_FAILURE indicates that a source-routed unicast sent from this node encountered a broken link. Note that this case occurs only if this node is a concentrator using many-to-one routing for inbound messages and source-routing for outbound messages. The node prior to the broken link generated the route error message and returned it to us along the many-to-one route.</p>
                    <p>A status of MANY_TO_ONE_ROUTE_FAILURE also occurs only if the local device is a concentrator, and indicates that a unicast sent to the local device along a many-to-one route encountered a broken link. The node prior to the broken link generated the route error message and forwarded it to the local device via a randomly chosen neighbor, taking advantage of the many-to-one nature of the route.</p>
                    <p>A status of MAC_INDIRECT_TIMEOUT indicates that a message sent to the target end device could not be delivered by the parent because the indirect transaction timer expired. Upon receipt of the route error, the stack sets the extended timeout for the target node in the address table, if present. It then calls this handler to indicate receipt of the error.</p>
                    <p>A new route error message is generated for each failed retry. Therefore, it is not unusual to receive three route error messages in succession for a single failed retried APS unicast. On the other hand, it is also not guaranteed that any route error messages will be delivered successfully at all.</p>
                </div>
            </article>
        </div>
        <div class="content">
            <h3>Details on values & references used by this tool</h3>
        </div>
        <div class="grid">
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">Reference Network ("Ideal")</p>
                </header>
                <div class="card-content">
                  <div class="content">
                    <ul>
                        <li>Coordinator: Sonoff Dongle-E</li>
                        <li>Firmware: 7.4.1 @darkxst</li>
                        <li>Devices: 33</li>
                        <ul>
                            <li>Routers: 20 (Mains single phase)</li>
                            <li>Including 2 power meters with 2-second update rate</li>
                            <li>End Devices: 13 (Battery)</li>
                        </ul>
                    </ul>
                  </div>
                </div>
            </div>
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">Software</p>
                </header>
                <div class="card-content">
                  <div class="content">
                    <ul>
                        <li>Zigbee2MQTT version: 1.36.1-dev commit: ae35aae</li>
                        <ul>
                            <li>Add-on in HAOS on Intel NUC6i5</li>
                            <li>Core 2024.3.3</li>
                            <li>Supervisor 2024.03.1</li>
                            <li>Operating System 12.1</li>
                        </ul>
                        <li>zigbee herdsman version: 0.41.2</li>
                        <li>zigbee herdsman converters version: 19.15.0</li>
                    </ul>
                  </div>
                </div>
            </div>
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">Sample</p>
                </header>
                <div class="card-content">
                  <div class="content">
                    <ul>
                        <li>100 consecutive hours</li>
                        <li>No pairing/removal</li>
                    </ul>
                    <ul>
                        <li>Operated 95% via automation</li>
                        <li>No route error reported over the entire duration</li>
                        <li>External interferences (neighbors & co) can be considered almost nil</li>
                    </ul>
                  </div>
                </div>
            </div>
        </div>
    </section>

    <script type="module" src="./index.ts"></script>
</body>

</html>